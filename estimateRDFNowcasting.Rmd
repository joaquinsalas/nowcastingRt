---
title: "Nowcasting del Número Básico de Reproducción para la Ciudad de México"
author: "Joaquín Salas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
bibliography: ref.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=3, fig.height=2)
```

## Introducción 
Este documento muestra la estimación de $R_t$, el número básica de reproducción, para 
Mexico. Una vez entendida la magnitud de la epidemia, $R_t$ representa el comportamiento que debe guiarnos sobre si podemos movernos o debemos quedarnos confinados. Valores de $R_t>1$ significan que el número de infectados está creciendo exponencialmente, mientras que valores de $R_t<1$ significan que el número de infectados tiende a ser menor en el tiempo. 


## Aproximación
El presente trabajo está basado en una idea de Carlo Tomasi, Profesor en la Universidad de Duke, para explotar el patrón de regularidad 
con la que se actualizan las cifras de confirmados positivos a COVID-19. En nuestra aproximación, construimos funciones de probabilidad que permiten estimar cual será el número de confirmados positivos para un cierto día habiéndose dado actualizaciones para esa misma fecha. Ya con el número estimado de confirmados positivos, se construyen posibles series de evolución del número de confirmados positivos. 

Para la determinación del número básico de reproducción para una de esas series de tiempo, nos basamos en  la librería para **R** (el lenguaje) *EpiEstim*, la cual se construye alrededor del trabajo de Cori *et al.*[-@cori2013new]. Cori *et al.* asumieron que la tasa a la que una persona infectada contagia a otras sigue un proceso de Poisson. Enseguida utilizan un proceso de inferencia bayesiano en donde asumen un *prior* en la forma de una distribución Gamma, lo cual resulta en un *posterior* que también sigue una distribución Gamma. Este documento describe la media y desviación estándar resultante como elemento más verosímil del comportamiento y la incertidumbre del estimado.  Siguiendo la recomendación de Cori *et al.* solo calculamos $R_t$ cuando el número de casos es mayor a 12 infectados. Además, siguiendo un estudio de periodicidad propio, calculamos $\tau$ como una semana. Finalmente, usando la investigación de Aghaali *et al.* [-@aghaali2020estimation] asignamos una media de 4.55 y una desviación estándar de 3.30 al *prior* Gamma. Notando que la caracterización del intervalo serial varía ampliamente y posiblemente requiera valores que reflejen la dinámica del país [@griffin2020rapid]. 
La estimación de $R_t$ que proporcionamos tiene la media y desviación estándar en ese momento.

Esta implementación  toma en cuenta la transmisión pre-sintomática, *i.e.*, el periodo de incubación, o el tiempo que toma a un infectado comenzar a mostrar síntomas, es mayor al periodo latente, o el tiempo a partir del cual un infectado puede contagiar a otros. Siguiendo Bar-On *et al.* [-@bar2020science] asumimos que el periodo latente dura tres días y el  periodo de incubación cinco días.  


# Términos y Condiciones
Términos y condiciones: Este reporte ha sido elaborado por “el autor” y se proporciona al público estrictamente para la salud pública, la educación, y la investigación académica. El reporte se basa en datos hechos públicos por la Secretaría de Salud y código que está disponible en el blog de información: \url{https://tinyurl.com/calculo-Rt}. “El autor” declara que no ofrece garantías con respecto al reporte, incluida la precisión, la idoneidad para el uso, y la fiabilidad. Se prohíbe estrictamente confiar en el reporte para obtener orientación médica o usar el reporte para fines comerciales. También se prohíbe estrictamente el uso de este reporte, su información y la documentación puesta a disposición con fines promocionales o comerciales. Consulte la información oficial de la Secretaría de Salud en donde expertos ayudan a mejorar la comprensión del virus SARS-CoV-2, informar al público, formular políticas para guiar una respuesta, mejorar la atención y salvar vidas.

## Mayor Información: 
Joaquín Salas. salas@ieee.org. Profesor del Instituto Politécnico Nacional. Cerro Blanco 141, Colinas del Cimatario, Querétaro. Tel. 442.1223.829



```{r epidemiology}

library(EpiEstim)
library(incidence) #incidence object
library(distcrete) #discretise a pdf
library(epitrix) #from mu, cv to scale and shape in the Gamma distribution
library(latex2exp) #include latex
library(ggplot2) #ggplot
 

library(matrixStats)
library(readxl)
library(xlsx)


#directorios de trabajo
code.dir = 'E:/Documents/informs/research/2020.06.05 delays/code/'
setwd(code.dir)
data.dir = 'E:/Documents/informs/research/2020.06.05 delays/data/'


#directorios con datos o codigo comunes
common.data.dir = 'E:\\Documents\\informs\\research\\covid-common\\data\\'
common.code.dir = 'E:\\Documents\\informs\\research\\covid-common\\code\\'
common.data = 'E:\\Documents\\informs\\research\\covid-common\\'

filename = paste(common.code.dir, "readData.R", sep = "")
source(filename)

prefix = "DF"


#############
#read the data from the last file of cases
filename = paste(data.dir, "infectious_samples",prefix,".xlsx", sep = "")
samples = suppressMessages(read_excel(filename))
samples = as.data.frame(samples)
#covid.before = readData(filename)

#filename = paste(common.data.dir, files[length(files)], sep = "")
#covid = readData(filename)



#############
#read the data from the last file of cases

#files in the data.dir directory corresponding to the Health Ministery data
files.pattern = "*COVID19MEXICO.csv"
files <- list.files(path = common.data.dir, pattern =  files.pattern)

filename = paste(common.data.dir, files[length(files)], sep = "")
covid = readData(filename)


#filter in positives
covid.pos = covid[covid$RESULTADO==1,]


#############
#read the list of states

filename = paste(common.data, "estados.csv", sep = "")
estados = read.csv(filename)


#for the states of Mexico
#unique.states = sort(unique(covid.pos$ENTIDAD_RES))

#for (state in unique.states) {
state = 9

#extract the state name
nombre = estados$ENTIDAD_FEDERATIVA[estados$CLAVE_ENTIDAD == state]
#print(droplevels(nombre))

#confirmados 
confirmed.state = covid.pos[covid.pos$ENTIDAD_RES ==  state,]

#we create an incidence object 
i <- incidence(confirmed.state$FECHA_SINTOMAS)

plot(i) + theme(axis.text.x = element_text(angle = 20, hjust = 1, size = 6))# full outbreak






#we subtract three because there is a latent period
incubation.period = 5
latent.period = 3
dates = as.Date(samples[,1], format="%d/%m/%Y")-(incubation.period-latent.period)

Rt = matrix(0, nrow = nrow(samples), ncol = ncol(samples))

for (sample in seq(2,ncol(samples))) {
  
  #create a data frame to feed the routine
  incid = data.frame(dates = dates, I=samples[,sample])
  
  #compute R
  
  #parameters for the Gamma prior distribution
  mu = 2.6
  sigma = 1.5
  res_parametric_si <- suppressMessages(estimate_R(incid, 
                                                   method="parametric_si",
                                                   config = make_config(list(
                                                     mean_si = mu, 
                                                     std_si = sigma))))
  
  Rt[8:nrow(Rt),sample] = res_parametric_si$R$`Mean(R)`  
}


  mean.values = rowMeans (Rt)
      
      sd.values = rowSds(Rt)
      lim.sup = mean.values + sd.values
      lim.inf = mean.values - sd.values
      
     
      
      
      RtNow = data.frame(days = dates[8:(length(dates)-2)], 
                             R =  mean.values[8:(length(dates)-2)],
                             sd =  sd.values[8:(length(dates)-2)],
                             lower = lim.inf[8:(length(dates)-2)],
                             upper = lim.sup[8:(length(dates)-2)])
      
      

      
      
      Rt.mu = RtNow$R[length(RtNow$R)]
      Rt.sd = RtNow$sd[length(RtNow$R)]
      fecha = RtNow$days[length(RtNow$days)]
      
      nombre = "Ciudad de Mexico"
      p<-suppressWarnings(ggplot() + 
                            geom_line(data=RtNow, 
                                      aes(x=days, 
                                          y=R, 
                                          color= "blue", linetype = "dashed"))+
                              
                            geom_ribbon(data=RtNow, 
                                        aes(x=days,
                                            y=R, 
                                            ymin=lower, ymax=upper),
                                        linetype=2, alpha=0.4)+
                            
                             
                            geom_hline(yintercept = 1,
                                       linetype = "solid", 
                                       color = "blue", size=0.3) +
                            theme (legend.position = "none",
                                   axis.text.x = element_text(angle = 20, hjust = 1)) +
                            ggtitle(nombre))
    plot(p)  
       
  estimate = data.frame(Rt = Rt.mu, sd = Rt.sd, fecha = fecha)
  estimate
  
  



```

